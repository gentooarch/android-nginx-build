name: Build Nginx for Android (Aarch64)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      # === 版本更新 ===
      NGX_VER: 1.24.0
      # OpenSSL 升级到 3.x (1.1.1 已停止维护且链接容易失效)
      OPENSSL_VER: 3.3.2
      PCRE_VER: 8.45
      # Zlib 升级到 1.3.1
      ZLIB_VER: 1.3.1
      
      CC: aarch64-linux-gnu-gcc
      CXX: aarch64-linux-gnu-g++

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu make wget tar perl

      - name: Download Source Code
        run: |
          echo "Downloading Sources..."
          
          # Nginx
          wget -q http://nginx.org/download/nginx-${NGX_VER}.tar.gz
          tar zxf nginx-${NGX_VER}.tar.gz
          
          # OpenSSL (使用 3.x 新地址)
          wget -q https://github.com/openssl/openssl/releases/download/openssl-${OPENSSL_VER}/openssl-${OPENSSL_VER}.tar.gz
          tar zxf openssl-${OPENSSL_VER}.tar.gz
          
          # PCRE (SourceForge)
          wget -q https://sourceforge.net/projects/pcre/files/pcre/${PCRE_VER}/pcre-${PCRE_VER}.tar.gz/download -O pcre-${PCRE_VER}.tar.gz
          tar zxf pcre-${PCRE_VER}.tar.gz
          
          # Zlib (改用 GitHub Release，比官网 zlib.net 稳定)
          wget -q https://github.com/madler/zlib/releases/download/v${ZLIB_VER}/zlib-${ZLIB_VER}.tar.gz
          tar zxf zlib-${ZLIB_VER}.tar.gz

      - name: Patch Nginx for OpenSSL Cross Compilation
        run: |
          cd nginx-${NGX_VER}
          # 修改 Nginx 对 OpenSSL 的编译调用
          # OpenSSL 3.x 和 1.1.x 在交叉编译时都需要 ./Configure linux-aarch64
          sed -i 's/.\/config/.\/Configure linux-aarch64/g' auto/lib/openssl/make

      - name: Configure and Build
        run: |
          cd nginx-${NGX_VER}
          
          ./configure \
            --prefix=/data/local/tmp/nginx \
            --user=nobody \
            --group=nobody \
            --with-cc=${CC} \
            --with-cpp=aarch64-linux-gnu-cpp \
            --with-pcre=../pcre-${PCRE_VER} \
            --with-zlib=../zlib-${ZLIB_VER} \
            --with-openssl=../openssl-${OPENSSL_VER} \
            --with-http_ssl_module \
            --with-http_v2_module \
            --with-http_gzip_static_module \
            --crossbuild=Linux:aarch64 \
            --with-cc-opt="-static -O2 -D_FILE_OFFSET_BITS=64 -Wno-error" \
            --with-ld-opt="-static" \
            --without-http_rewrite_module \
            --without-http_gzip_module \
            --with-pcre-jit
            
          # -Wno-error: 防止新版 GCC 因为小的警告停止编译
          
          make -j$(nproc)

      - name: Verify Binary
        run: |
          cd nginx-${NGX_VER}/objs
          file nginx
          if file nginx | grep -q "statically linked"; then
            echo "Build Success: Binary is statically linked"
          else
            echo "Build Failed: Binary is NOT statically linked"
            exit 1
          fi

      - name: Rename Artifact
        run: |
          mv nginx-${NGX_VER}/objs/nginx nginx-android-aarch64

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nginx-android-binary
          path: nginx-android-aarch64
