name: Build Nginx for Android

on:
  push:
  workflow_dispatch:

env:
  NGINX_VERSION: 1.26.2
  ANDROID_API: 21
  ARCH: aarch64

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Install build tools
        run: |
          sudo apt update
          sudo apt install -y build-essential wget unzip

      - name: Download Android NDK
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          unzip android-ndk-r26d-linux.zip
          echo "NDK_HOME=$PWD/android-ndk-r26d" >> $GITHUB_ENV

      - name: Download Nginx
        run: |
          wget http://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz
          tar -xzf nginx-${NGINX_VERSION}.tar.gz

      - name: Configure and Build
        run: |
          cd nginx-${NGINX_VERSION}

          export TOOLCHAIN=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64
          export CC=$TOOLCHAIN/bin/clang
          export AR=$TOOLCHAIN/bin/llvm-ar
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          export STRIP=$TOOLCHAIN/bin/llvm-strip
          export TARGET=aarch64-linux-android
          export API=$ANDROID_API

          export CFLAGS="--target=$TARGET$API -fPIC"
          export LDFLAGS="--target=$TARGET$API -fPIE -pie"

          ./configure \
            --crossbuild=Linux::aarch64 \
            --with-cc="$CC $CFLAGS" \
            --with-ld-opt="$LDFLAGS" \
            --with-cc-opt="$CFLAGS" \
            --without-http_rewrite_module \
            --without-http_gzip_module \
            --without-http_ssi_module \
            --without-pcre \
            --without-http_upstream_zone_module \
            --without-select_module \
            --without-poll_module \
            --with-threads \
            --prefix=$PWD/output

          make -j$(nproc)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nginx-android
          path: nginx-${{ env.NGINX_VERSION }}/objs/nginx
